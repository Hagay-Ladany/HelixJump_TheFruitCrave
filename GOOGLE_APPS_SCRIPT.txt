const SHEET_NAME = 'Sheet1';

function doPost(e) {
  const sheet = SpreadsheetApp.getActive().getSheetByName(SHEET_NAME);
  
  // Handle FormData (avoids CORS preflight)
  let name, score;
  if (e.parameter) {
    // FormData comes as parameters
    name = e.parameter.name || 'Anonymous';
    score = parseInt(e.parameter.score) || 0;
  } else {
    // Fallback: try JSON parsing
    try {
      const body = JSON.parse(e.postData.contents);
      name = body.name || 'Anonymous';
      score = parseInt(body.score) || 0;
    } catch(err) {
      name = 'Anonymous';
      score = 0;
    }
  }
  
  sheet.appendRow([name, score, new Date()]);
  
  return ContentService
    .createTextOutput(JSON.stringify({status: "OK"}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet() {
  const sheet = SpreadsheetApp.getActive().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  data.shift(); // remove header row
  
  const leaderboard = data
    .map(r => ({
      name: r[0] || 'Anonymous',
      score: parseInt(r[1]) || 0,
      timestamp: r[2] ? new Date(r[2]).toISOString() : new Date().toISOString()
    }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 50); // Return top 50
  
  return ContentService
    .createTextOutput(JSON.stringify(leaderboard))
    .setMimeType(ContentService.MimeType.JSON);
}